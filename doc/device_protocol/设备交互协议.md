# 上报协议

## 基本上报格式

**13 protoVx.y.z02 sfwVal SN08 MainInfolen01 BatLevel Temper02  Acc BCC  6p 6p**  

| **序号** | **字段**        | 字段名       | 示例中该字段的内容(Hex) | 长度 | 备注(无特殊说明都是Hex格式) |
| -------- | --------------- | ------------ | ----------------------- | ---- | --------------------------- |
| 01       | 13              | 起始符       | 13                      | 01   | 起始符都13                  |
| 02       | **protoVx.y.z** | 协议版本     | 0201                    | 02   |                             |
| 03       | **sfwVal**      | 软件版本数值 | **15**                  | 01   |                             |
| 04       | **SN**          | 设备号       | **6134441313**          | 05   | SN号                        |
| 06       | **BatLevel**    | 电量指示     | **0B**                  | 01   |                             |
| 07       | **Temper**      | 温度         | **FF6C**                | 02   |                             |
| 12       | **Acc**         | 加速度       | **010D  FE9D 4113**     | 06   |                             |
| 23       | **BCC**         | 校验码       | **C4**                  | 01   |                             |
| 24       | **6p 6p**       | 结束符       |                         | 02   |                             |

## 字段说明

### 起始和束符

每一条设备上报的基本数据都是以13开始，以6p 6p结束。

特殊情况下服务器有可能一次性收到2条拼接在一起的数据，如果当做一条数据处，虽然起始和结束符正确，但是校验很有可能是不正确的，这时候不能直接将这2条数据丢掉，要做特殊处理：

1）校验出错，查看数据长度是否正确；

2）数据长度正确，校验不对可以丢弃该条数据；

3）数据长度太小，直接丢弃该条数据；

### 协议版本字段

**protoVx.y.z**： 固定2个字节，共16位，分成3个位域，每个位域转换成十进制数值表示，V2.0.10的位域图如下列表所示：

| Bit 15~12 | Bit 11~8 | Bit 7~0   |
| --------- | -------- | --------- |
| 主版本    | 次版本   | Debug版本 |
| 2         | 0        | 0a        |

 

1）Debug版本：有一些小改动就会经常更新的版本，比如增加几个下行命令。一般设备端的数据上报协议有了新改动但服务器端可能还不支持，但只要支持主次版本就可以继续使用的版本；

2）次版本：当Debug版本有了一些改动的积累，而且设备端和服务器端都同步了这些改动；

3）主版本：功能模块有较大的变动，或者整套协议变化较大，或者完全重构发布的版本。一般主版本之间的协议不兼容，需要服务器端分开解析，而且设备端会尽量使用最新版的协议。

比如软件上报时的协议版本的内容为0x2001,对应**V2.0.01**,表示当前设备软件使用的是**V2.0.01**版本的数据上报协议。

###  软件版本数值字段

**sfwVal：**软件版本数值，固定1个字节，转换成十进制表示。

### 设备号字段

**SN**： 固定6个字节，也可以是定制的SN号，直接以HEX表示，解析之后不用转换成十进制，高字节在前，低字节在后，顺序排列。

### 电量字段

**BatLevel**：电池电量，十进制范围0-100，固定1个字节。 

### 温度字段

**Temper** **：**温度。长度固定2个字节，高位在前。以2进制补码的形式上报，

该值为0对应温度为25℃，0-15bit的最高位即第15位为符号位，

温度计算公式： （+-）Temper/256 +25℃

### Acc

**Acc**：加速度传感信息体，固定6个字节，是Acc信息体，3个轴固定6个字节，每2个字节对应一个轴，每个轴的数据为16bit，最高位为符号位，当符号位为1时，以补码的形式发送。高位在前。

### 校验码字段

**BCC:** 从13开始到**校验码**的前一个字节的BCC异或校验，校验码长度一个字节。

 



# 下行协议

## **下行数据格式说明**

 

**下发命令格式**： +B1301,SorftwareVer,Cmd[,Para],BccNb\r\n       

| 起始符 | 软件版本(十进制) | Cmd      | 设置参数(可变) | **BCC**校验 | **结束符** |
| ------ | ---------------- | -------- | -------------- | ----------- | ---------- |
| +B1301 | SorftwareVer     | 命令类型 | Para           | **BccNb**   | \r\n       |

 

**上行响应格式**：+B1301,sn,SorftwareVer,Cmd[,Para],BccNb\r\n

| 起始符    | 设备号 | 软件版本(十进制) | Cmd      | 设置参数(可变) | **BCC****校验** | **结束符** |
| --------- | ------ | ---------------- | -------- | -------------- | --------------- | ---------- |
| +B1301RSP | SN     | SorftwareVer     | 命令类型 | Para           | **BccNb**       | \r\n       |

**注意：起始符、字段与字段之间的间隔符都是`,`。

**下行命令以及终端设备的上行响应都以字符串来表示**，**字段之间以逗号隔开**，字段说明：

1）下行命令开头关键字：+B1301,。

2）下行命令结尾：\r\n ,回车换行。

3）**SorftwareVer**：软件版本号，长度固定1个字节，例如：11,表示1.1,发布版本和DEBUG版本号都是1。

4）**Cmd**: 具体的命令类型信息，比如设置休眠时间SLPT等。

6）[,**Para**]：下发命令中携带的设置参数，长度根据具体的命令类型而定，部分命令没有携带设置参数。

7）**BccNb**: '+'到最后一个‘，’之间的所有字符的BCC校验值，长度固定1个字节。

## 下行命令

#### 设置休眠时间

补充说明：设置参数的大小范围：**60****分钟-44640****分钟**（用十进制表示，最大30天）。

示例：+B1301,10,SLPT,600,40\r\n  //每次打卡后休眠600分钟

响应：+B1301RSP,sn,10,CHKSLPT,60,61\r\n

#### 查询休眠时间

示例：+B1301,10,CHKSLPT,1A\r\n

响应：+B1301RSP,sn,ver,CHKSLPT,sleeptime,BCC\r\n

# OTA

## OTA数据协议说明

该协议规定了2G终端进行OTA升级时，服务器与2G终端之间的通信数据协议，且该协议基于TCP通信实现。本协议规定2G终端的OTA由服务器端发起。2G终端接收到软件版本更新通知，保存更新命令中的相关参数，根据这些参数向服务器请求对应的升级子包，每个升级子包做一次BCC校验，所有的升级子包接收完成并粘包之后做一次MD5校验，校验通过后进行版本更新。

**下行命令以及终端设备的上行响应都以字符串来表示，不包括升级子包的数据包。**    

## 平台

服务器端先计算升级包的MD5校验码，然后提前将整个升级包划分成大小1024字节的子包，最后一个子包可以不满1024字节，再计算每个子包的BCC校验码，使用这些参数生成以下的OTA更新命令。

### OTA升级的下行命令格式

+NBOTA,pinfo,fsize,pnumb,psize,bcc[pnumb],md5,cmdbcc\r\n

示例：

+NBOTA,1010d100,35912,36,1024,737F248AFF7582B469D6C42FE30ABE7E51A74B0CFF02B0DBCEA56C1F4A16C3B6BC0DE634,97CD95AD88A5944C8BE8594AFFB3C764,2B\r\n

命令格式说明：

* +CPOTA：OTA升级命令指示符；
*  pinfo: 升级包信息，hex-4字节，比如：软件版本10+硬件版本10_资源型号d1+通用版本00/专属版本01 ,名字正确才能防止软件下载到硬件不适配的设备上。
*  fsize: 升级包软件大小，32bit；
*  pnumb: 升级包划分的子包个数,16bit；
*  psize: 子包大小,16bit；
*  bcc[pnumb]: 按顺序排列的每个子包的BCC校验码,hex-1字节，字符串-2字节； 
*  md5: MD5校验码，hex-16字节，字符串-32字节；
*  cmdbcc: 命令的BCC校验码,取“+”号到命令最后一个“，”号 之间的数据进行校验。

### 终端部分

终端收到服务器OTA升级命令，首先会对该命令进行软件版本、硬件版本、产品型号等参数进行校验，校验通过就保存命令中的相关参数，然后向服务器发出请求，获取对应的子包；如果校验失败，终端会上报相应的错误类型，详情请参考附件1。



### OTA子包请求的上行命令格式

+ReqNOTAB:sn,ver,pcnt,psize,offset,cmdbcc\r\n

示例：+ReqNOTAB:6134441313,11,45,1024,45056,05\r\n



命令格式说明：

* +ReqNOTAB: 请求OTA子包的命令提示符；
*   ver: 软件版本号
*  pcnt: OTA子包的包号,范围1~pnumb; 

*  psize: 子包大小,16bit；

*  offset: 文件当前的偏移位置，即当前终端接收到的所有子包的大小之和。

*  cmdbcc: 命令的BCC校验码,取“+”号到命令最后一个“，”号 之间的数据进行校验。

 

### OTA升级命令校验错误，上报错误响应的格式

+NOTABERR:sn,OTACMDERR,errcode,cmdbcc\r\n

示例：+NOTABERR:6134441313,OTACMDERR,201,54\r\n

命令格式说明：

* +NOTABERR：OTA更新过程产生错误的上行响应指示符。

* OTACMDERR: 固定字符串，表示该错误属于OTA升级下发命令错误的类型。

* errcode：该命令的错误码，详情请参考附件1.

* cmdbcc: 命令的BCC校验码,取“+”号到命令最后一个“，”号 之间的数据进行校验。

 

### OTA子包错误，上报错误响应的格式

+NOTABERR:SN,PATCHERR,errcode,cmdbcc\r\n

示例：

+NOTABERR:6134441313,PATCHERR,404,09\r\n

* +NOTABERR：OTA更新过程产生错误的上行响应指示符。

* PATCHERR: 固定字符串，表示该错误属于请求升级子包过程出错的类型。

* errcode：该命令的错误码，详情请参考附件2.

* cmdbcc: 命令的BCC校验码,取“+”号到命令最后一个“，”号 之间的数据进行校验。

 

### OTA子包接收完成通知

+NOTABOVER:sn,cmdbcc\r\n

示例：+NOTABOVER:6134441313,6F\r\n

 

### 丢包重传

终端收到任何一个子包都会进行BCC校验，当校验不通过时，终端会重新发送请求命令直到子包的BCC校验通过，最多重发5次子包请求命令，5次之后子包BCC校验依然不通过则OTA升级失败。



# **附件1：OTA升级下行命令校验错误码列表**

| 错误码 | 定义                                                     |
| ------ | -------------------------------------------------------- |
| 731    | 命令字符串长度不够                                       |
| 735    | 命令不符合格式，每个字段必须以逗号隔开                   |
| 738    | 命令BCC校验不对                                          |
| 739    | 升级包文件名长度不对，规定pname字符串长度为8，HEX长度为4 |
| 740    | 软件版本不对                                             |
| 745    | 升级包大小不对，最小10KByte,最大100KByte                 |
| 749    | 文件大小与子包数量分割不正确                             |
| 756    | 子包的BCC校验码长度与子包个数不对应                      |
| 740    | MD5校验码长度不对                                        |

 

 

# **附件2：OTA升级子包错误码列表**

| 错误码 | 定义                                                         |
| ------ | ------------------------------------------------------------ |
| 801    | FLASH编程错误                                                |
| 803    | 当前请求的升级子包BCC校验错误                                |
| 805    | 当前请求的升级子包接收超时，暂时限定每个子包接收最大时长1分钟 |
|        |                                                              |

 

# **附件3：下行命令响应错误码列表**

| 错误码 | 定义             |
| ------ | ---------------- |
| 02     | 命令长度错误     |
| 03     | 命令软件版本错误 |
| 04     | 命令校验错误     |
| 05     | FLASH操作失败    |
| 06     | 命令参数错误     |

 

